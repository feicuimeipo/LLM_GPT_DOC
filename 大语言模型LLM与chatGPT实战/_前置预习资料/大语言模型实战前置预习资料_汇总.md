

# 安装指南

视频链接：https://www.bilibili.com/video/BV1hE411t7RN/?p=1&vd_source=ffe29668e0a2e15974a3e4de41359bf1

> PyTorch深度学习环境配置主流环境：Anaconda+PyTorch+PyCharm, 引文不包含Pycharm安装



## Python安装

> 别安装python3.7，有时会有问题

查看python版本

```shell
python -v
- 
# Python 3.11.0 (main, Oct 24 2022, 18:26:48) [MSC v.1933 64 bit (AMD64)] on win32
```

> 也可以在安装Anaconda时，通过conda安装python

## PyTorch安装

### 安装Anaconda

> 安装了Anaconda就将大部分的Pytorch功能安装了，同时安装了虚拟环境conda。
>
> 官网：https://www.anaconda.com/
>
> 中文：https://anaconda.org.cn/
>
> 仓库：https://repo.anaconda.com/
>
> 所有版本的Anaconda: https://repo.anaconda.com/archive/



#### 下载 - for windows： 

安装指南： https://anaconda.org.cn/anaconda/install/windows/       

下载： https://www.anaconda.com/download#downloads



#### 安装

笔者下载的版本是“Anaconda3-2023.09-0-Windows-x86_64.exe”, 点击安装即可。

> 从文件名看py对应的版本 ： Anaconda3... 后的‘3’代表对应的python的大版本是3，Anaconda2... 则python2。



#### 验证

搜索 Anaconda Powershell Prompt ，

![image-20231014035905772](.\PyTorch.assets\image-20231014035905772.png)



并点击打开，如看到如下的对话框说明安装成功

![image-20231014040011381](.\PyTorch.assets\image-20231014040011381.png)



### 显卡配置

![image-20231014040145809](.\PyTorch.assets\image-20231014040145809.png)

深度学习离不开显卡，现在一些tensflow、pytorch等都只支持NVIDA的显卡，但是否有显卡对于学习pytorch并没有影响，前者只是起到训练加速的作用。



显卡配置主要涉及以下内容

1. 驱动
2. CUDA Toolkit
3. 其他：随Pytorch的离线？安装



For windows ： 

任务管理器  - 性能：

> 如果能正常显示型号，意味着显卡驱动正式安装了

![image-20231014041034644](E:\我的博客\大语言模型\前置预习资料-部分笔记\PyTorch\PyTorch.assets\image-20231014041034644.png)



### 多个python切换与pytorch安装

>  conda可完成pytorch的多版本切换（使用 conda指令）



进入Anaconda Powershell Prompt命令提示行



#### 版本切换

创建环境（已有可不安装）

```
conda create -n pytorch python=3.11.0
```

激活环境

```
conda activate python=3.11.0
```

查看当前环境下是否有pytorch

```
pip list | findstr pytorch
```

没有，则需要安装pytorch

#### pytorch安装

> 官网：https://pytorch.org
>
> 源码：https://github.com/pytorch/pytorch





1、访问官网首页，找到 "INSTALL PYTORCH" 楼层，根据以下信息选择对应的版本，

![image-20231014101603841](E:\我的博客\大语言模型\前置预习资料-部分笔记\PyTorch\PyTorch.assets\image-20231014101603841.png)

PyTorch Build： Stable

Package: conda或pip，在windows推荐使用conda,  linux推荐pip）

Language:  选Python (Python、Java、C++)

Compute Platform: 

-  如果发现电脑上没有对应的NVIDA（比如NIVDA Gefoce...) ，可不安装CUDA。 选"CPU"即可。

- CUDA 11.8，CUDA 12.1，我们要保证我们的CUDA driver版本 >= CUDA Runtime版本。

- [CUDA最新版本安装](https://developer.nvidia.com/cuda-downloads?target_os=Windows&target_arch=x86_64&target_version=10&target_type=exe_local)  CUDA 12.2可自动检查系统的兼容性。





2、打开Anaconda Powershell Prompts 窗口，输入上述图片中  Running this Common对应的指令

> 点  [install previous versions of PyTorch](https://pytorch.org/get-started/previous-versions)  可看到看有的安装包



```shell
# 运行安装指令

conda install pytorch==2.0.1 torchvision==0.15.2 torchaudio==2.0.2 cpuonly -c pytorch

# 如下条信息安装结束
# Downloading and Extracting Packages
# ...
#Preparing transaction: done
#Verifying transaction: done
#Executing transaction: done

# 如果之前就已安装，会提示'# All requested packages already installed'
# ------------------------------------
# 查看安装情况
pip list |findstr torch

# 如下信息说明安装上了
# torch                         2.1.0
# torchaudio                    2.1.0
# torchvision                   0.16.0
```

> 也可手工下载 cudatoolkit-x.x.x.bz与pytorch-x.x.x-......bz 复制到初始安装Anaconda的安装目录 ```C:\Users\[用户]\anaconda3\pkgs\ ```下并解压，再运行。



#### 验证torch安装

```shell
python  # 进入python环凌晨
>> import torch  # 如果该步骤没有报错(或不输出任何信息)说明安装成功
>> import torchvision
>> torch.cuda.is_available()  # 如果返回True意味着torch是否可使用GPU，输出为False - 集成显卡 - ComputerPlatform选CPU时也是。
   Flase  
```



## Pycharm安装 （略)



## 第一个项目: helloworld

### 打开pycharm，New Project - > PurePython

![image-20231014130305587](E:\我的博客\大语言模型\前置预习资料-部分笔记\PyTorch\PyTorch.assets\image-20231014130305587.png)



![image-20231014132444686](E:\我的博客\大语言模型\前置预习资料-部分笔记\PyTorch\PyTorch.assets\image-20231014132444686.png)



![image-20231014133453769](E:\我的博客\大语言模型\前置预习资料-部分笔记\PyTorch\PyTorch.assets\image-20231014133453769.png)

Interpreter显示<New Virtualenv>

Location: 

没有虚拟环进创建虚拟环境

> 早期版本-- C:\Users\[用户]\anaconda3\envs\pytorch\...

### 查询pytorch安装位置

```shell
where Python
python
>> import torch
>> torch.__version__ #查看版本
>> otrch.__path__    #查看路径
```









# 附录

# CUDA

 CUDA(Compute Unified Device Architecture)，是显卡厂商NVIDIA推出的运算平台。 CUDA是一种由NVIDIA推出的通用并行计算架构，该架构使GPU能够解决复杂的计算问题。

整个CUDA涉及到三个方面的内容：硬件显卡（算力）、显卡驱动（cuda driver version）、cuda runtime version（上图中要选择的内容）。一定要让它们三个之间互相匹配，pytorch的GPU版本才能够运用显卡。

CUDA官网：[链接](https://developer.nvidia.com/zh-cn/cuda-toolkit)。



google搜索cuda，点进Wikipedia后往下翻可以看到一张表格，找到上面显卡型号对应的算力（[这个网站](https://link.zhihu.com/?target=https%3A//www.xincanshu.com/)里面输入显卡型号也可以查询）(6.1)

![image-20231014054744468](.\PyTorch.assets\image-20231014054744468.png)



### 查询当前机器的GPU是否合适装CUDA 

先可查看当前主机是硬件型号与查看GPU对应的型号，方法如下：

- 通过“软件管理、鲁大师”
- 或 打开''设备管理器'': Intel(R) UHD Graphics
- 或任务管理器:  右上角



再进入 https://www.geforce.cn/hardware/technology/cuda/supported-gpus

![image-20231014043641850](.\PyTorch.assets\image-20231014043641850.png)



### 命令行检查 -  CUDA driver版本

运行：

```
nvidia-smi 
```

![image-20231014053658315](.\PyTorch.assets\image-20231014053658315.png)

####  

### CUDA 12.2 Release Notes

https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html#major-components



## conda

## 什么是Conda、Miniconda、Anaconda

Conda是一个包和环境管理的工具。支持[Windows](https://so.csdn.net/so/search?q=Windows&spm=1001.2101.3001.7020)、macOS和Linux。Conda可以快速的安装、运行和更新包和相关的依赖。Conda也可以轻易地创建、保存、加载和转换环境。

Anaconda 是一个用于科学计算的 Python 发行版，支持 [Linux](https://so.csdn.net/so/search?q=Linux&spm=1001.2101.3001.7020), Mac, Windows, 包含了conda、conda-build、Python和众多科学计算的包及其依赖。

Miniconda 是一个 Anaconda 的轻量级替代，默认只包含了 conda，Python 和一些它们所以依赖的包。



常用的python虚拟环境管理工具有：

1. Virtualenv
2. Conda
3. pipenv
4. venv



通过使用这些工具，我们可以很容易的创建虚拟环境。

安装: 安装anaconda时自动安装conda

使用：通过 Anconda Prompt(conda) 使用conda



## ## 常用命令



升级

 ```conda update -n base-c defaults conda```

配置代理

```
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
conda config --set show_channel_urls yes
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/
```




## stable diffusion安装

由于很多商务本没有独立显卡，只有Intel的集成显卡，在配置安装stable diffusion 时候需要特殊对待，参考不少帖子，各取部分现稍加整合。



- 第一步是先配置环境，主要是安装Anaconda + Pytorch

Win10+非英伟达显卡+Anaconda+Pytorch安装

https://blog.csdn.net/zcsdn1996/article/details/112476263



- 第二步是安装 stable diffusion

访问链接:  https://zhuanlan.zhihu.com/p/578233719， 参考stable diffusion的安装过程

- 最后在执行 

  ```
  webui-user.bat 
  ```



时一直失败，报错是 RuntimeError: Couldn't install gfpgan，于是又是各种搜索，目前参照 https://www.bilibili.com/read/cv19991459/ 这个帖子的第一个办法改动，在每个前面添加 https://ghproxy.com/ , 安装成功了。



生成图片的时候，竟然又报错了 RuntimeError: "LayerNormKernelImpl" not implemented for 'Half'，解决办法是这个帖子 https://www.bilibili.com/read/cv19132184?from=articleDetail 里面提的如下改动：

编辑stable-diffusion-webui目录下的./repositories/stable-diffusion/ldm/models/diffusion/ddim.py

将第21、22行的cuda改成cpu

修改后重新启动根目录的 webui-user.bat 文件，浏览器运行 http://127.0.0.1:7860/ ，成功绘图！







